<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>음악 분류 진행률</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="dark-mode">
    <div class="center-container">
        <div class="progress-container">
            <h2>🎵 음악 분류 진행률</h2>
            
            {% if url %}
            <div class="url-info">
                <p><strong>분석 중인 링크:</strong> <a href="{{ url }}" target="_blank">{{ url }}</a></p>
            </div>
            {% endif %}
            
            <div class="progress-content">
                <div class="progress-spinner">
                    <div class="loading-spinner-large"></div>
                </div>
                
                <div class="progress-text">
                    <h3 id="progress-title">분류 작업을 시작합니다...</h3>
                    <p id="progress-message">잠시만 기다려주세요...</p>
                </div>
                
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-percentage" id="progress-percentage">0%</div>
                </div>
                
                <div class="progress-steps">
                    <div class="step" id="step-start">
                        <span class="step-icon">🚀</span>
                        <span class="step-text">시작</span>
                    </div>
                    <div class="step" id="step-download">
                        <span class="step-icon">📥</span>
                        <span class="step-text">다운로드</span>
                    </div>
                    <div class="step" id="step-process">
                        <span class="step-icon">🔍</span>
                        <span class="step-text">분석</span>
                    </div>
                    <div class="step" id="step-complete">
                        <span class="step-icon">✅</span>
                        <span class="step-text">완료</span>
                    </div>
                </div>
            </div>
            
            <div class="progress-actions">
                <button type="button" class="big-btn" onclick="goBack()">← 돌아가기</button>
            </div>
        </div>
    </div>
    
    <script>
        const taskId = '{{ task_id }}';
        let eventSource = null;
        
        function updateProgress(data) {
            const title = document.getElementById('progress-title');
            const message = document.getElementById('progress-message');
            const fill = document.getElementById('progress-fill');
            const percentage = document.getElementById('progress-percentage');
            
            if (title) title.textContent = data.message;
            if (message) message.textContent = `진행률: ${data.progress}%`;
            if (fill) fill.style.width = `${data.progress}%`;
            if (percentage) percentage.textContent = `${data.progress}%`;
            
            // 단계 업데이트
            updateSteps(data.stage);
            
            // 완료되면 결과 표시
            if (data.stage === 'completed' && data.result) {
                showResult(data.result);
            } else if (data.stage === 'error') {
                setTimeout(() => {
                    alert('분류 중 오류가 발생했습니다.');
                    window.location.href = '/';
                }, 2000);
            }
        }
        
        function updateSteps(stage) {
            const steps = {
                'starting': 'step-start',
                'downloading': 'step-download',
                'processing': 'step-process',
                'completed': 'step-complete'
            };
            
            // 모든 단계 초기화
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            
            // 현재 단계 활성화
            const currentStep = steps[stage];
            if (currentStep) {
                const stepEl = document.getElementById(currentStep);
                if (stepEl) {
                    stepEl.classList.add('active');
                }
            }
            
            // 이전 단계들 완료 표시
            const stageOrder = ['starting', 'downloading', 'processing', 'completed'];
            const currentIndex = stageOrder.indexOf(stage);
            for (let i = 0; i < currentIndex; i++) {
                const prevStep = steps[stageOrder[i]];
                if (prevStep) {
                    const stepEl = document.getElementById(prevStep);
                    if (stepEl) {
                        stepEl.classList.add('completed');
                    }
                }
            }
        }
        
        function showResult(result) {
            const progressContent = document.querySelector('.progress-content');
            if (!progressContent) return;
            
            // 결과 HTML 생성
            let resultHTML = '<div class="result-section">';
            resultHTML += '<h2>분류 결과</h2>';
            
            if (result.error) {
                resultHTML += '<div class="error-message">';
                resultHTML += '<h3>❌ 오류 발생</h3>';
                resultHTML += `<p>${result.error}</p>`;
                resultHTML += '</div>';
            } else {
                resultHTML += '<div class="prediction-result">';
                
                if (result.genre) {
                    resultHTML += '<div class="result-group">';
                    resultHTML += '<h3>🎼 장르 분류</h3>';
                    resultHTML += `<p><strong>예측 장르:</strong> ${result.genre} (${(result.confidence * 100).toFixed(2)}%)</p>`;
                    resultHTML += '</div>';
                }
                
                if (result.method) {
                    resultHTML += '<div class="result-group">';
                    resultHTML += '<h3>🔍 분류 방법</h3>';
                    resultHTML += `<p><strong>사용된 방법:</strong> ${result.method}</p>`;
                    if (result.note) {
                        resultHTML += `<p><strong>참고:</strong> ${result.note}</p>`;
                    }
                    resultHTML += '</div>';
                }
                
                resultHTML += '</div>';
            }
            
            resultHTML += '</div>';
            
            // 진행률 내용을 결과로 교체
            progressContent.innerHTML = resultHTML;
            
            // 돌아가기 버튼 추가
            const actionsDiv = document.querySelector('.progress-actions');
            if (actionsDiv) {
                actionsDiv.innerHTML = '<button type="button" class="big-btn" onclick="goBack()">← 돌아가기</button>';
            }
        }
        
        function goBack() {
            window.location.href = '/';
        }
        
        // Server-Sent Events 연결
        function connectProgress() {
            eventSource = new EventSource(`/api/progress_stream/${taskId}`);
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('진행률 데이터 받음:', data);  // 디버깅용
                    updateProgress(data);
                } catch (e) {
                    console.error('진행률 데이터 파싱 오류:', e);
                }
            };
            
            eventSource.onerror = function(event) {
                console.error('진행률 스트림 오류:', event);
                // 재연결 시도
                setTimeout(connectProgress, 5000);
            };
        }
        
        // 페이지 로드 시 연결 시작
        document.addEventListener('DOMContentLoaded', function() {
            connectProgress();
        });
        
        // 페이지 언로드 시 연결 종료
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
