<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìŒì•… ë¶„ë¥˜ ì§„í–‰ë¥ </title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .batch-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .batch-summary h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .summary-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        
        .stat-item {
            margin: 10px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            min-width: 120px;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        .batch-results {
            margin-top: 20px;
        }
        
        .batch-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }
        
        .batch-item.success {
            border-left-color: #28a745;
        }
        
        .batch-item.error {
            border-left-color: #dc3545;
        }
        
        .batch-item h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .batch-item h4 a {
            color: #007bff;
            text-decoration: none;
        }
        
        .batch-item h4 a:hover {
            text-decoration: underline;
        }
        
        .result-details {
            font-size: 0.9rem;
            color: #666;
        }
        
        .result-details p {
            margin: 5px 0;
        }
        
        .error-text {
            color: #dc3545;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .summary-stats {
                flex-direction: column;
            }
            
            .stat-item {
                margin: 5px 0;
            }
        }
    </style>
</head>
<body class="dark-mode">
    <div class="center-container">
        <div class="progress-container">
            <h2 id="progress-header">ğŸµ ìŒì•… ë¶„ë¥˜ ì§„í–‰ë¥ </h2>
            
            {% if url %}
            <div class="url-info">
                <p><strong>ë¶„ì„ ì¤‘ì¸ ë§í¬:</strong> <a href="{{ url }}" target="_blank">{{ url }}</a></p>
            </div>
            {% endif %}
            
            <div id="batch-info" style="display: none;">
                <p><strong>ë°°ì¹˜ ë¶„ë¥˜ ì§„í–‰ ì¤‘...</strong></p>
                <p id="batch-status">ì—¬ëŸ¬ ë§í¬ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            
            <div class="progress-content">
                <div class="progress-spinner">
                    <div class="loading-spinner-large"></div>
                </div>
                
                <div class="progress-text">
                    <h3 id="progress-title">ë¶„ë¥˜ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤...</h3>
                    <p id="progress-message">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
                </div>
                
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-percentage" id="progress-percentage">0%</div>
                </div>
                
                <div class="progress-steps">
                    <div class="step" id="step-start">
                        <span class="step-icon">ğŸš€</span>
                        <span class="step-text">ì‹œì‘</span>
                    </div>
                    <div class="step" id="step-download">
                        <span class="step-icon">ğŸ“¥</span>
                        <span class="step-text">ë‹¤ìš´ë¡œë“œ</span>
                    </div>
                    <div class="step" id="step-process">
                        <span class="step-icon">ğŸ”</span>
                        <span class="step-text">ë¶„ì„</span>
                    </div>
                    <div class="step" id="step-complete">
                        <span class="step-icon">âœ…</span>
                        <span class="step-text">ì™„ë£Œ</span>
                    </div>
                </div>
            </div>
            
            <div class="progress-actions">
                <button type="button" class="big-btn" onclick="goBack()">â† ëŒì•„ê°€ê¸°</button>
            </div>
        </div>
    </div>
    
    <script>
        const taskId = '{{ task_id }}';
        let eventSource = null;
        
        function updateProgress(data) {
            const title = document.getElementById('progress-title');
            const message = document.getElementById('progress-message');
            const fill = document.getElementById('progress-fill');
            const percentage = document.getElementById('progress-percentage');
            
            if (title) title.textContent = data.message;
            if (message) message.textContent = `ì§„í–‰ë¥ : ${data.progress}%`;
            if (fill) fill.style.width = `${data.progress}%`;
            if (percentage) percentage.textContent = `${data.progress}%`;
            
            // ë°°ì¹˜ ë¶„ë¥˜ì¸ì§€ í™•ì¸
            if (data.message && data.message.includes('ë°°ì¹˜ ë¶„ë¥˜')) {
                showBatchInfo();
            }
            
            // ë‹¨ê³„ ì—…ë°ì´íŠ¸
            updateSteps(data.stage);
            
            // ì™„ë£Œë˜ë©´ ê²°ê³¼ í‘œì‹œ
            if (data.stage === 'completed' && data.result) {
                if (data.result.batch_results) {
                    showBatchResult(data.result);
                } else {
                    showResult(data.result);
                }
            } else if (data.stage === 'error') {
                setTimeout(() => {
                    alert('ë¶„ë¥˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    window.location.href = '/';
                }, 2000);
            }
        }
        
        function updateSteps(stage) {
            const steps = {
                'starting': 'step-start',
                'downloading': 'step-download',
                'processing': 'step-process',
                'completed': 'step-complete'
            };
            
            // ëª¨ë“  ë‹¨ê³„ ì´ˆê¸°í™”
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            
            // í˜„ì¬ ë‹¨ê³„ í™œì„±í™”
            const currentStep = steps[stage];
            if (currentStep) {
                const stepEl = document.getElementById(currentStep);
                if (stepEl) {
                    stepEl.classList.add('active');
                }
            }
            
            // ì´ì „ ë‹¨ê³„ë“¤ ì™„ë£Œ í‘œì‹œ
            const stageOrder = ['starting', 'downloading', 'processing', 'completed'];
            const currentIndex = stageOrder.indexOf(stage);
            for (let i = 0; i < currentIndex; i++) {
                const prevStep = steps[stageOrder[i]];
                if (prevStep) {
                    const stepEl = document.getElementById(prevStep);
                    if (stepEl) {
                        stepEl.classList.add('completed');
                    }
                }
            }
        }
        
        function showBatchInfo() {
            const batchInfo = document.getElementById('batch-info');
            const header = document.getElementById('progress-header');
            if (batchInfo) batchInfo.style.display = 'block';
            if (header) header.textContent = 'ğŸ“‹ ë°°ì¹˜ ë¶„ë¥˜ ì§„í–‰ë¥ ';
        }
        
        function showBatchResult(result) {
            const progressContent = document.querySelector('.progress-content');
            if (!progressContent) return;
            
            // ë°°ì¹˜ ê²°ê³¼ HTML ìƒì„±
            let resultHTML = '<div class="result-section">';
            resultHTML += '<h2>ğŸ“‹ ë°°ì¹˜ ë¶„ë¥˜ ê²°ê³¼</h2>';
            
            if (result.batch_results && result.urls) {
                const totalCount = result.batch_results.length;
                const successCount = result.batch_results.filter(r => r.status === 'success').length;
                const failedCount = totalCount - successCount;
                
                // ìš”ì•½ í†µê³„
                resultHTML += '<div class="batch-summary">';
                resultHTML += '<h3>ğŸ“Š ë¶„ë¥˜ ê²°ê³¼ ìš”ì•½</h3>';
                resultHTML += '<div class="summary-stats">';
                resultHTML += `<div class="stat-item"><div class="stat-number">${totalCount}</div><div class="stat-label">ì´ ë§í¬</div></div>`;
                resultHTML += `<div class="stat-item"><div class="stat-number">${successCount}</div><div class="stat-label">ì„±ê³µ</div></div>`;
                resultHTML += `<div class="stat-item"><div class="stat-number">${failedCount}</div><div class="stat-label">ì‹¤íŒ¨</div></div>`;
                resultHTML += '</div></div>';
                
                // ê° ê²°ê³¼ í•­ëª©
                resultHTML += '<div class="batch-results">';
                result.batch_results.forEach((item, index) => {
                    resultHTML += `<div class="batch-item ${item.status}">`;
                    resultHTML += `<h4>${index + 1}. <a href="${item.url}" target="_blank">${item.url}</a></h4>`;
                    
                    if (item.status === 'success') {
                        resultHTML += '<div class="result-details">';
                        if (item.genre) {
                            resultHTML += `<p><strong>ì¥ë¥´:</strong> ${item.genre} (${(item.confidence * 100).toFixed(1)}%)</p>`;
                        }
                        if (item.genres) {
                            const topGenres = item.genres.slice(0, 3).map(g => `${g[0]}(${(g[1] * 100).toFixed(1)}%)`).join(', ');
                            resultHTML += `<p><strong>ì¥ë¥´ (ê¸°ì¡´ í˜•ì‹):</strong> ${topGenres}</p>`;
                        }
                        if (item.emotions) {
                            const topEmotions = item.emotions.slice(0, 3).map(e => `${e[0]}(${(e[1] * 100).toFixed(1)}%)`).join(', ');
                            resultHTML += `<p><strong>ê°ì •:</strong> ${topEmotions}</p>`;
                        }
                        if (item.youtube_info) {
                            resultHTML += `<p><strong>ì œëª©:</strong> ${item.youtube_info.title}</p>`;
                        }
                        if (item.method) {
                            resultHTML += `<p><strong>ë°©ë²•:</strong> ${item.method}</p>`;
                        }
                        resultHTML += '</div>';
                    } else {
                        resultHTML += `<p class="error-text">âŒ ${item.error}</p>`;
                    }
                    resultHTML += '</div>';
                });
                resultHTML += '</div>';
            }
            
            resultHTML += '</div>';
            
            // ì§„í–‰ë¥  ë‚´ìš©ì„ ê²°ê³¼ë¡œ êµì²´
            progressContent.innerHTML = resultHTML;
            
            // ëŒì•„ê°€ê¸° ë²„íŠ¼ ì¶”ê°€
            const actionsDiv = document.querySelector('.progress-actions');
            if (actionsDiv) {
                actionsDiv.innerHTML = '<button type="button" class="big-btn" onclick="goBack()">â† ëŒì•„ê°€ê¸°</button>';
            }
        }
        
        function showResult(result) {
            const progressContent = document.querySelector('.progress-content');
            if (!progressContent) return;
            
            // ê²°ê³¼ HTML ìƒì„±
            let resultHTML = '<div class="result-section">';
            resultHTML += '<h2>ë¶„ë¥˜ ê²°ê³¼</h2>';
            
            if (result.error) {
                resultHTML += '<div class="error-message">';
                resultHTML += '<h3>âŒ ì˜¤ë¥˜ ë°œìƒ</h3>';
                resultHTML += `<p>${result.error}</p>`;
                resultHTML += '</div>';
            } else {
                resultHTML += '<div class="prediction-result">';
                
                if (result.genre) {
                    resultHTML += '<div class="result-group">';
                    resultHTML += '<h3>ğŸ¼ ì¥ë¥´ ë¶„ë¥˜</h3>';
                    resultHTML += `<p><strong>ì˜ˆì¸¡ ì¥ë¥´:</strong> ${result.genre} (${(result.confidence * 100).toFixed(2)}%)</p>`;
                    resultHTML += '</div>';
                }
                
                if (result.method) {
                    resultHTML += '<div class="result-group">';
                    resultHTML += '<h3>ğŸ” ë¶„ë¥˜ ë°©ë²•</h3>';
                    resultHTML += `<p><strong>ì‚¬ìš©ëœ ë°©ë²•:</strong> ${result.method}</p>`;
                    if (result.note) {
                        resultHTML += `<p><strong>ì°¸ê³ :</strong> ${result.note}</p>`;
                    }
                    resultHTML += '</div>';
                }
                
                resultHTML += '</div>';
            }
            
            resultHTML += '</div>';
            
            // ì§„í–‰ë¥  ë‚´ìš©ì„ ê²°ê³¼ë¡œ êµì²´
            progressContent.innerHTML = resultHTML;
            
            // ëŒì•„ê°€ê¸° ë²„íŠ¼ ì¶”ê°€
            const actionsDiv = document.querySelector('.progress-actions');
            if (actionsDiv) {
                actionsDiv.innerHTML = '<button type="button" class="big-btn" onclick="goBack()">â† ëŒì•„ê°€ê¸°</button>';
            }
        }
        
        function goBack() {
            window.location.href = '/';
        }
        
        // Server-Sent Events ì—°ê²°
        function connectProgress() {
            eventSource = new EventSource(`/api/progress_stream/${taskId}`);
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('ì§„í–‰ë¥  ë°ì´í„° ë°›ìŒ:', data);  // ë””ë²„ê¹…ìš©
                    updateProgress(data);
                } catch (e) {
                    console.error('ì§„í–‰ë¥  ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                }
            };
            
            eventSource.onerror = function(event) {
                console.error('ì§„í–‰ë¥  ìŠ¤íŠ¸ë¦¼ ì˜¤ë¥˜:', event);
                // ì¬ì—°ê²° ì‹œë„
                setTimeout(connectProgress, 5000);
            };
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì—°ê²° ì‹œì‘
        document.addEventListener('DOMContentLoaded', function() {
            connectProgress();
        });
        
        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì—°ê²° ì¢…ë£Œ
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
