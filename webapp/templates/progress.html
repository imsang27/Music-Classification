<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìŒì•… ë¶„ë¥˜ ì§„í–‰ë¥ </title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="dark-mode">
    <div class="center-container">
        <div class="progress-container">
            <h2>ğŸµ ìŒì•… ë¶„ë¥˜ ì§„í–‰ë¥ </h2>
            
            {% if url %}
            <div class="url-info">
                <p><strong>ë¶„ì„ ì¤‘ì¸ ë§í¬:</strong> <a href="{{ url }}" target="_blank">{{ url }}</a></p>
            </div>
            {% endif %}
            
            <div class="progress-content">
                <div class="progress-spinner">
                    <div class="loading-spinner-large"></div>
                </div>
                
                <div class="progress-text">
                    <h3 id="progress-title">ë¶„ë¥˜ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤...</h3>
                    <p id="progress-message">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
                </div>
                
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-percentage" id="progress-percentage">0%</div>
                </div>
                
                <div class="progress-steps">
                    <div class="step" id="step-start">
                        <span class="step-icon">ğŸš€</span>
                        <span class="step-text">ì‹œì‘</span>
                    </div>
                    <div class="step" id="step-download">
                        <span class="step-icon">ğŸ“¥</span>
                        <span class="step-text">ë‹¤ìš´ë¡œë“œ</span>
                    </div>
                    <div class="step" id="step-process">
                        <span class="step-icon">ğŸ”</span>
                        <span class="step-text">ë¶„ì„</span>
                    </div>
                    <div class="step" id="step-complete">
                        <span class="step-icon">âœ…</span>
                        <span class="step-text">ì™„ë£Œ</span>
                    </div>
                </div>
            </div>
            
            <div class="progress-actions">
                <button type="button" class="big-btn" onclick="goBack()">â† ëŒì•„ê°€ê¸°</button>
            </div>
        </div>
    </div>
    
    <script>
        const taskId = '{{ task_id }}';
        let eventSource = null;
        
        function updateProgress(data) {
            const title = document.getElementById('progress-title');
            const message = document.getElementById('progress-message');
            const fill = document.getElementById('progress-fill');
            const percentage = document.getElementById('progress-percentage');
            
            if (title) title.textContent = data.message;
            if (message) message.textContent = `ì§„í–‰ë¥ : ${data.progress}%`;
            if (fill) fill.style.width = `${data.progress}%`;
            if (percentage) percentage.textContent = `${data.progress}%`;
            
            // ë‹¨ê³„ ì—…ë°ì´íŠ¸
            updateSteps(data.stage);
            
            // ì™„ë£Œë˜ë©´ ê²°ê³¼ í‘œì‹œ
            if (data.stage === 'completed' && data.result) {
                showResult(data.result);
            } else if (data.stage === 'error') {
                setTimeout(() => {
                    alert('ë¶„ë¥˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    window.location.href = '/';
                }, 2000);
            }
        }
        
        function updateSteps(stage) {
            const steps = {
                'starting': 'step-start',
                'downloading': 'step-download',
                'processing': 'step-process',
                'completed': 'step-complete'
            };
            
            // ëª¨ë“  ë‹¨ê³„ ì´ˆê¸°í™”
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            
            // í˜„ì¬ ë‹¨ê³„ í™œì„±í™”
            const currentStep = steps[stage];
            if (currentStep) {
                const stepEl = document.getElementById(currentStep);
                if (stepEl) {
                    stepEl.classList.add('active');
                }
            }
            
            // ì´ì „ ë‹¨ê³„ë“¤ ì™„ë£Œ í‘œì‹œ
            const stageOrder = ['starting', 'downloading', 'processing', 'completed'];
            const currentIndex = stageOrder.indexOf(stage);
            for (let i = 0; i < currentIndex; i++) {
                const prevStep = steps[stageOrder[i]];
                if (prevStep) {
                    const stepEl = document.getElementById(prevStep);
                    if (stepEl) {
                        stepEl.classList.add('completed');
                    }
                }
            }
        }
        
        function showResult(result) {
            const progressContent = document.querySelector('.progress-content');
            if (!progressContent) return;
            
            // ê²°ê³¼ HTML ìƒì„±
            let resultHTML = '<div class="result-section">';
            resultHTML += '<h2>ë¶„ë¥˜ ê²°ê³¼</h2>';
            
            if (result.error) {
                resultHTML += '<div class="error-message">';
                resultHTML += '<h3>âŒ ì˜¤ë¥˜ ë°œìƒ</h3>';
                resultHTML += `<p>${result.error}</p>`;
                resultHTML += '</div>';
            } else {
                resultHTML += '<div class="prediction-result">';
                
                if (result.genre) {
                    resultHTML += '<div class="result-group">';
                    resultHTML += '<h3>ğŸ¼ ì¥ë¥´ ë¶„ë¥˜</h3>';
                    resultHTML += `<p><strong>ì˜ˆì¸¡ ì¥ë¥´:</strong> ${result.genre} (${(result.confidence * 100).toFixed(2)}%)</p>`;
                    resultHTML += '</div>';
                }
                
                if (result.method) {
                    resultHTML += '<div class="result-group">';
                    resultHTML += '<h3>ğŸ” ë¶„ë¥˜ ë°©ë²•</h3>';
                    resultHTML += `<p><strong>ì‚¬ìš©ëœ ë°©ë²•:</strong> ${result.method}</p>`;
                    if (result.note) {
                        resultHTML += `<p><strong>ì°¸ê³ :</strong> ${result.note}</p>`;
                    }
                    resultHTML += '</div>';
                }
                
                resultHTML += '</div>';
            }
            
            resultHTML += '</div>';
            
            // ì§„í–‰ë¥  ë‚´ìš©ì„ ê²°ê³¼ë¡œ êµì²´
            progressContent.innerHTML = resultHTML;
            
            // ëŒì•„ê°€ê¸° ë²„íŠ¼ ì¶”ê°€
            const actionsDiv = document.querySelector('.progress-actions');
            if (actionsDiv) {
                actionsDiv.innerHTML = '<button type="button" class="big-btn" onclick="goBack()">â† ëŒì•„ê°€ê¸°</button>';
            }
        }
        
        function goBack() {
            window.location.href = '/';
        }
        
        // Server-Sent Events ì—°ê²°
        function connectProgress() {
            eventSource = new EventSource(`/api/progress_stream/${taskId}`);
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('ì§„í–‰ë¥  ë°ì´í„° ë°›ìŒ:', data);  // ë””ë²„ê¹…ìš©
                    updateProgress(data);
                } catch (e) {
                    console.error('ì§„í–‰ë¥  ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                }
            };
            
            eventSource.onerror = function(event) {
                console.error('ì§„í–‰ë¥  ìŠ¤íŠ¸ë¦¼ ì˜¤ë¥˜:', event);
                // ì¬ì—°ê²° ì‹œë„
                setTimeout(connectProgress, 5000);
            };
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì—°ê²° ì‹œì‘
        document.addEventListener('DOMContentLoaded', function() {
            connectProgress();
        });
        
        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì—°ê²° ì¢…ë£Œ
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
