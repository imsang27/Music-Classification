<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìŒì•… ë¶„ë¥˜ ì›¹</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="dark-mode">
    <div class="mode-toggle">
        <button type="button" onclick="toggleMode()">í™”ì´íŠ¸ ëª¨ë“œ</button>
    </div>
    
    <!-- ëª¨ë¸ ìƒíƒœ í‘œì‹œ -->
    <div class="model-status">
        <div class="status-header">
            <div class="model-label-container">
                <span class="status-label">AI ëª¨ë¸:</span>
                <span id="model-name" class="model-name" style="display: none;"></span>
            </div>
            <button type="button" class="refresh-model-btn" onclick="checkModelStatus()" title="ëª¨ë¸ ìƒíƒœ ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
        </div>
        <div class="status-content">
            <span class="status-value {% if model_status == 'ë¡œë“œë¨' %}status-success{% else %}status-error{% endif %}">
                {{ model_status }}
            </span>
            {% if model_status == 'ë¡œë“œë˜ì§€ ì•ŠìŒ' %}
                <span class="status-note">(ê·œì¹™ ê¸°ë°˜ ë¶„ë¥˜ë§Œ ì‚¬ìš© ê°€ëŠ¥)</span>
            {% endif %}
        </div>
    </div>
    
    <div class="center-container">
        <!-- íŒŒì¼ ì—…ë¡œë“œ í¼ -->
        <div class="form-section">
            <h3>ğŸ“ íŒŒì¼ë¡œ ë¶„ë¥˜í•˜ê¸°</h3>
            <form action="{{ url_for('classify') }}" method="post" enctype="multipart/form-data" id="file-form">
                <div class="file-search-bar">
                    <span class="cta-text" id="random-cta"></span>
                    <div class="right-group">
                        <span id="file-name"></span>
                        <label for="audio_file" class="file-label">ìŒì•… ì°¾ê¸°</label>
                        <input type="file" id="audio_file" name="audio_file" required onchange="updateFileName()">
                    </div>
                </div>
                <div class="button-group">
                    <button type="submit" class="big-btn" name="action" value="wav2vec2">ğŸµ AIë¡œ ë¶„ì„í•˜ê¸°</button>
                    <button type="submit" class="big-btn" name="action" value="manual">âœ‹ ì§ì ‘ ë¶„ë¥˜í•˜ê¸°</button>
                    <button type="submit" class="big-btn" name="action" value="rule">ğŸ“‹ ê·œì¹™ìœ¼ë¡œ ë¶„ë¥˜</button>
                    <button type="submit" class="big-btn" name="action" value="ml">ğŸ¤– ë¨¸ì‹ ëŸ¬ë‹ ë¶„ë¥˜</button>
                    <button type="submit" class="big-btn" name="action" value="lyrics">ğŸ“ ê°€ì‚¬ë¡œ ë¶„ì„í•˜ê¸°</button>
                    <button type="submit" class="big-btn" name="action" value="hybrid">ğŸ”— í†µí•© ë¶„ë¥˜í•˜ê¸°</button>
                </div>
            </form>
        </div>

        <!-- URL ë§í¬ í¼ -->
        <div class="form-section">
            <h3>ğŸ”— ë§í¬ë¡œ ë¶„ë¥˜í•˜ê¸°</h3>
            <form action="{{ url_for('classify_url') }}" method="post" id="url-form">
                <div class="url-input-group">
                    <div class="url-input-container">
                        <input type="url" id="url_input" name="url" placeholder="YouTube ë§í¬ë‚˜ ìŒì•… íŒŒì¼ ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                               required class="url-input" onchange="validateUrl()">
                        <button type="button" class="preview-btn" onclick="getLinkPreview()" title="ë§í¬ ë¯¸ë¦¬ë³´ê¸°">ğŸ‘ï¸</button>
                    </div>
                    <div id="url-validation" class="validation-message"></div>
                </div>
                
                <!-- ë§í¬ ë¯¸ë¦¬ë³´ê¸° -->
                <div id="link-preview" class="link-preview" style="display: none;">
                    <div class="preview-content">
                        <div class="preview-header">
                            <span id="preview-platform" class="platform-badge"></span>
                            <button type="button" class="close-preview" onclick="hideLinkPreview()">Ã—</button>
                        </div>
                        <div id="preview-info" class="preview-info">
                            <!-- ë¯¸ë¦¬ë³´ê¸° ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button type="submit" class="big-btn" name="action" value="wav2vec2">ğŸµ AIë¡œ ë¶„ì„í•˜ê¸°</button>
                    <button type="submit" class="big-btn" name="action" value="rule">ğŸ“‹ ê·œì¹™ìœ¼ë¡œ ë¶„ë¥˜</button>
                </div>
            </form>
        </div>

        <!-- ì¼ê´„ ë¶„ë¥˜ í¼ -->
        <div class="form-section">
            <h3>ğŸ“‹ ì—¬ëŸ¬ ë§í¬ ì¼ê´„ ë¶„ë¥˜í•˜ê¸°</h3>
            <form action="{{ url_for('batch_classify') }}" method="post" id="batch-form">
                <div class="batch-input-group">
                    <textarea id="urls_input" name="urls" placeholder="ì—¬ëŸ¬ ë§í¬ë¥¼ ì¤„ë°”ê¿ˆì´ë‚˜ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”...&#10;ì˜ˆì‹œ:&#10;https://youtube.com/watch?v=...&#10;https://youtube.com/watch?v=...&#10;https://example.com/music.mp3" 
                              required class="batch-textarea"></textarea>
                </div>
                <div class="button-group">
                    <button type="submit" class="big-btn" name="action" value="wav2vec2">ğŸµ AIë¡œ ì¼ê´„ ë¶„ì„í•˜ê¸°</button>
                </div>
            </form>
        </div>

        <!-- ì—…ë¡œë“œ í´ë” ê´€ë¦¬ -->
        <div class="form-section">
            <h3>ğŸ—‚ï¸ ì—…ë¡œë“œ í´ë” ê´€ë¦¬</h3>
            <div class="uploads-info">
                <div class="info-header">
                    <span class="info-label">ğŸ“ ì—…ë¡œë“œëœ íŒŒì¼ ì •ë³´</span>
                    <button type="button" class="refresh-btn" onclick="refreshUploadsInfo()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>
                <div id="uploads-stats" class="uploads-stats">
                    <p>ë¡œë”© ì¤‘...</p>
                </div>
                <div id="uploads-files" class="uploads-files" style="display: none;">
                    <!-- íŒŒì¼ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                <div class="uploads-actions">
                    <button type="button" class="clear-btn" onclick="clearUploads()" disabled>ğŸ—‘ï¸ í´ë” ë¹„ìš°ê¸°</button>
                </div>
            </div>
        </div>

        <!-- ë¶„ë¥˜ ê²°ê³¼ í‘œì‹œ -->
        {% if prediction %}
            <div class="result-section">
                <h2>ë¶„ë¥˜ ê²°ê³¼</h2>
                {% if url %}
                    <p><strong>ë¶„ì„í•œ ë§í¬:</strong> <a href="{{ url }}" target="_blank">{{ url }}</a></p>
                {% endif %}
                {% if prediction.error %}
                    <div class="error-message">
                        <h3>âŒ ì˜¤ë¥˜ ë°œìƒ</h3>
                        <p>{{ prediction.error }}</p>
                    </div>
                {% else %}
                    <div class="prediction-result">
                        {% if prediction.genre %}
                            <div class="result-group">
                                <h3>ğŸ¼ ì¥ë¥´ ë¶„ë¥˜</h3>
                                <p><strong>ì˜ˆì¸¡ ì¥ë¥´:</strong> {{ prediction.genre }} ({{ "%.2f"|format(prediction.confidence * 100) }}%)</p>
                            </div>
                        {% endif %}
                        {% if prediction.genres %}
                            <div class="result-group">
                                <h3>ğŸ¼ ì¥ë¥´ ë¶„ë¥˜ (ê¸°ì¡´ í˜•ì‹)</h3>
                                <ul>
                                    {% for genre, confidence in prediction.genres %}
                                        <li>{{ genre }} ({{ "%.2f"|format(confidence * 100) }}%)</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                        {% if prediction.emotions %}
                            <div class="result-group">
                                <h3>ğŸ˜Š ê°ì • ë¶„ë¥˜</h3>
                                <ul>
                                    {% for emotion, confidence in prediction.emotions %}
                                        <li>{{ emotion }} ({{ "%.2f"|format(confidence * 100) }}%)</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                        {% if prediction.youtube_info %}
                            <div class="result-group">
                                <h3>ğŸ“º YouTube ì •ë³´</h3>
                                <p><strong>ì œëª©:</strong> {{ prediction.youtube_info.title }}</p>
                                <p><strong>ì—…ë¡œë”:</strong> {{ prediction.youtube_info.uploader }}</p>
                                <p><strong>ê¸¸ì´:</strong> {{ prediction.youtube_info.duration }}ì´ˆ</p>
                            </div>
                        {% endif %}
                        {% if prediction.method %}
                            <div class="result-group">
                                <h3>ğŸ” ë¶„ë¥˜ ë°©ë²•</h3>
                                <p><strong>ì‚¬ìš©ëœ ë°©ë²•:</strong> {{ prediction.method }}</p>
                                {% if prediction.note %}
                                    <p><strong>ì°¸ê³ :</strong> {{ prediction.note }}</p>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        {% endif %}

        <!-- ì¼ê´„ ë¶„ë¥˜ ê²°ê³¼ í‘œì‹œ -->
        {% if batch_results %}
            <div class="result-section">
                <h2>ì¼ê´„ ë¶„ë¥˜ ê²°ê³¼</h2>
                <div class="batch-summary">
                    <p><strong>ì´ ì²˜ë¦¬ëœ ë§í¬:</strong> {{ batch_results|length }}ê°œ</p>
                    {% set success_count = batch_results|selectattr('status', 'equalto', 'success')|list|length %}
                    {% set failed_count = batch_results|length - success_count %}
                    <p><strong>ì„±ê³µ:</strong> {{ success_count }}ê°œ</p>
                    <p><strong>ì‹¤íŒ¨:</strong> {{ failed_count }}ê°œ</p>
                </div>
                
                <div class="batch-results">
                    {% for result in batch_results %}
                        <div class="batch-item {% if result.status == 'error' %}error{% else %}success{% endif %}">
                            <h4>{{ loop.index }}. <a href="{{ result.url }}" target="_blank">{{ result.url }}</a></h4>
                            {% if result.status == 'success' %}
                                <div class="result-details">
                                    {% if result.genre %}
                                        <p><strong>ì¥ë¥´:</strong> {{ result.genre }} ({{ "%.1f"|format(result.confidence * 100) }}%)</p>
                                    {% endif %}
                                    {% if result.genres %}
                                        <p><strong>ì¥ë¥´ (ê¸°ì¡´ í˜•ì‹):</strong> 
                                            {% for genre, confidence in result.genres[:3] %}
                                                {{ genre }}({{ "%.1f"|format(confidence * 100) }}%){% if not loop.last %}, {% endif %}
                                            {% endfor %}
                                        </p>
                                    {% endif %}
                                    {% if result.emotions %}
                                        <p><strong>ê°ì •:</strong> 
                                            {% for emotion, confidence in result.emotions[:3] %}
                                                {{ emotion }}({{ "%.1f"|format(confidence * 100) }}%){% if not loop.last %}, {% endif %}
                                            {% endfor %}
                                        </p>
                                    {% endif %}
                                    {% if result.youtube_info %}
                                        <p><strong>ì œëª©:</strong> {{ result.youtube_info.title }}</p>
                                    {% endif %}
                                    {% if result.method %}
                                        <p><strong>ë°©ë²•:</strong> {{ result.method }}</p>
                                    {% endif %}
                                </div>
                            {% else %}
                                <p class="error-text">âŒ {{ result.error }}</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>